<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0 text-white">Gerenciar: <%= course.nome %></h4>
        <a href="/cursos" class="btn btn-sm btn-light">Voltar</a>
    </div>
    <div class="card-body bg-light">
        <form action="/cursos/editar/<%= course.id %>" method="POST">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>Nome do Curso</label>
                    <input type="text" name="nome" class="form-control" value="<%= course.nome %>" required>
                </div>
                <div class="form-group col-md-6">
                    <label>Status</label>
                    <select name="status" class="form-control" required>
                        <option value="Inscrições Abertas" <%= course.status == 'Inscrições Abertas' ? 'selected' : '' %>>Inscrições Abertas</option>
                        <option value="Em Andamento" <%= course.status == 'Em Andamento' ? 'selected' : '' %>>Em Andamento</option>
                        <option value="Finalizado" <%= course.status == 'Finalizado' ? 'selected' : '' %>>Finalizado</option>
                        <option value="Pausado" <%= course.status == 'Pausado' ? 'selected' : '' %>>Pausado</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Descrição</label>
                <textarea name="descricao" class="form-control" rows="3"><%= course.descricao %></textarea>
            </div>
            <button type="submit" class="btn btn-info btn-sm">Salvar Alterações do Curso</button>
        </form>
    </div>
</div>


<div class="card shadow-sm mt-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Conteúdos do Curso</h5>
        <button class="btn btn-success" type="button" data-toggle="collapse" data-target="#formAdicionar">
            <i class="bi bi-plus-lg"></i> Adicionar Novo Item
        </button>
    </div>

    <div class="collapse p-3 bg-light border-bottom" id="formAdicionar">
        <h6 class="text-muted">Novo Item</h6>
        
        <form action="/cursos/<%= course.id %>/conteudos" method="POST">
            <div class="form-row">
                                <div class="form-group col-md-4">
                    <label>Categoria</label>
                    <select name="categoria" id="categoriaSelect" class="form-control" required onchange="atualizarFormatos(); preencherTitulo()">
                        <option value="">Selecione...</option>
                        <option value="Aula">Aula</option>
                        <option value="Avaliação">Avaliação</option>
                    </select>
                </div>
                                <div class="form-group col-md-4">
                    <label>Título</label>
                    <input type="text" name="titulo" id="tituloInput" class="form-control" placeholder="Título descritivo" required>
                </div>
                                <div class="form-group col-md-4">
                    <label>Formato</label>
                    <select name="formato" id="formatoSelect" class="form-control" required>
                        <option value="">Selecione a categoria...</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Link</label>
                <input type="url" name="link" class="form-control" placeholder="https://...">
            </div>
            <button type="submit" class="btn btn-success">Adicionar Item à Lista</button>
        </form>
    </div>

    <div class="card-body p-0">
        <% if (!course.conteudos || course.conteudos.length === 0) { %>
            <div class="alert alert-warning m-3 text-center">
                Nenhuma aula cadastrada.
            </div>
        <% } else { %>
            <%
                // 1. Separar Aulas e Avaliações
                const aulas = course.conteudos.filter(item => item.categoria === 'Aula');
                const avaliacoes = course.conteudos.filter(item => item.categoria === 'Avaliação');

                // 2. Função de Ordenação (para garantir ordem crescente de número)
                const sorter = (a, b) => {
                    const matchA = a.titulo.match(/\d+/);
                    const matchB = b.titulo.match(/\d+/);
                    const numA = matchA ? parseInt(matchA[0]) : 0;
                    const numB = matchB ? parseInt(matchB[0]) : 0;
                    return numA - numB;
                };

                // 3. Juntar e ordenar
                const conteudosOrdenados = [
                    ...aulas.sort(sorter),
                    ...avaliacoes.sort(sorter)
                ];
            %>
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                                                <th style="width: 50%;">Título</th>
                        <th>Formato</th> 
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    <% conteudosOrdenados.forEach(item => { %>
                    <tr>
                        <td>
                                                        <span class="badge badge-secondary mr-2"><%= item.categoria %></span>
                            <strong><%= item.titulo %></strong>
                        </td>
                        <td>
                            <%= item.formato %>
                        </td>
                        <td>
                            <form action="/cursos/<%= course.id %>/conteudos/<%= item.id %>/delete" method="POST" onsubmit="return confirm('Remover este conteúdo?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Remover</button>
                            </form>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } %>
    </div>
</div>

<div class="card shadow-sm mt-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">Alunos Matriculados (<%= course.students ? course.students.length : 0 %>)</h5>
    </div>
    <div class="card-body">
        <% if (!course.students || course.students.length === 0) { %>
            <div class="alert alert-info text-center">Nenhum aluno matriculado neste curso.</div>
        <% } else { %>
            <ul class="list-group">
                <% course.students.forEach(student => { %>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong><%= student.nome %></strong> - <%= student.email %>
                        </div>
                        <span class="badge badge-primary badge-pill">Matriculado</span>
                    </li>
                <% }); %>
            </ul>
        <% } %>
    </div>
</div>
<script>
    // ESTA SEÇÃO FOI OMITIDA NA ÚLTIMA RESPOSTA, CAUSANDO O ERRO. RESTAURADA ABAIXO.

    // Variável global para armazenar o próximo número de item
    let proximaAula = 1;
    let proximaAvaliacao = 1;

    // Função para preencher o Título automaticamente
    function preencherTitulo() {
        const categoria = document.getElementById("categoriaSelect").value;
        const tituloInput = document.getElementById("tituloInput");
        
        let prefixo = '';
        let proxNumero = 0;
        
        // Se a categoria mudar, recalcula os números.
        if (categoria === 'Aula' || categoria === 'Avaliação') {
            prefixo = categoria;
            
            // Busca o maior número de aula/avaliação na listagem atual para sugerir o próximo
            const aulasExistentes = document.querySelectorAll('span.badge-secondary');
            
            let maiorAula = 0;
            let maiorAvaliacao = 0;

            aulasExistentes.forEach(badge => {
                const tipo = badge.textContent.trim();
                const linha = badge.closest('tr');
                
                const tituloCompletoElement = linha.querySelector('td strong');
                if (!tituloCompletoElement) return;

                const tituloCompleto = tituloCompletoElement.textContent.trim();
                const numeroMatch = tituloCompleto.match(/\d+/);
                const numero = numeroMatch ? parseInt(numeroMatch[0]) : 0;
                
                if (tipo === 'Aula' && numero > maiorAula) {
                    maiorAula = numero;
                } else if (tipo === 'Avaliação' && numero > maiorAvaliacao) {
                    maiorAvaliacao = numero;
                }
            });
            
            proximaAula = maiorAula + 1;
            proximaAvaliacao = maiorAvaliacao + 1;
            
            proxNumero = (categoria === 'Aula') ? proximaAula : proximaAvaliacao;
            
        } else {
            tituloInput.value = "";
            return;
        }

        // Define o valor do input, substituindo o que estiver lá.
        tituloInput.value = `${prefixo} ${proxNumero} - `;
        
        // Move o cursor para o final para facilitar a digitação
        setTimeout(() => {
            tituloInput.focus();
            tituloInput.setSelectionRange(tituloInput.value.length, tituloInput.value.length);
        }, 0);
    }


    // Função para preencher os formatos (mantida)
    function atualizarFormatos() {
        const categoria = document.getElementById("categoriaSelect").value;
        const formatoSelect = document.getElementById("formatoSelect");
        formatoSelect.innerHTML = "";
        
        let opcoes = [];
        if (categoria === "Aula") opcoes = ["Chamada Online", "Vídeo", "Arquivo PDF", "Link Externo"];
        else if (categoria === "Avaliação") opcoes = ["Questionário", "Texto Escrito (PDF)", "Print da Tela"];
        else opcoes = ["Selecione a categoria..."];

        opcoes.forEach(op => {
            let el = document.createElement("option");
            el.text = op; el.value = op;
            formatoSelect.add(el);
        });
    }
</script>